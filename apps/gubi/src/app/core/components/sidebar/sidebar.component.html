<p-drawer
  [visible]="isSidebarOpen()"
  [modal]="isMobile()"
  [closable]="false"
  (visibleChange)="layoutService.setIsSidebarOpen($event)"
  [styleClass]="sidebarClass()"
  role="navigation"
  aria-label="Menu principal"
>
  <ng-template #header>
    <a class="flex flex-col items-center justify-center w-full cursor-pointer" [routerLink]="'/spaces'" aria-label="Ir para Espaços">
      <img [src]="isSidebarExpanded() ? 'gb_name.svg' : 'gb_logo.svg'" alt="Gubi" class="logo w-1/3 lg:w-1/2" />
    </a>
  </ng-template>

  <ng-template #content>
    <div class="flex flex-col h-full pt-40" [ngClass]="{ 'items-center': !isSidebarExpanded() }">
      <div class="flex flex-col gap-3 justify-start">
        @for (item of menuItems; track item.route) { @if(item.subMenu) {
        <div>
          <a
            [routerLink]="item.route"
            class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors text-neutral-700 duration-150 p-ripple"
            [ngClass]="isActive(item.route) && !hasActiveSubMenu(item) ? 'bg-[#3d3935]/10 border-l-4 border-[#3d3935]': 'hover:bg-gray-100'"
            [pTooltip]="!isSidebarExpanded() ? item.label : undefined"
          >
            <em [class]="item.icon" [ngClass]="{ 'text-gray-500': !isActive(item.route) }"></em>
            <span *ngIf="isSidebarExpanded()" class="ml-3 text-sm font-medium whitespace-nowrap"> {{ item.label }} </span>
            <button *ngIf="isSidebarExpanded()" class="ml-auto" (click)="item.isExpanded = !item.isExpanded; $event.preventDefault(); $event.stopPropagation();">
              <em [ngClass]="item.isExpanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"></em>
            </button>
          </a>
          @if(isSidebarExpanded() && item.isExpanded) {
          <div class="flex flex-col gap-1 mt-1 pl-4">
            @for (subItem of item.subMenu; track subItem.route){
            <a
              [routerLink]="subItem.route"
              class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors text-neutral-700 duration-150 p-ripple"
              [ngClass]="{ 'bg-[#3d3935]/10 border-l-4 border-[#3d3935]': isActive(subItem.route), 'hover:bg-gray-100': !isActive(subItem.route) }"
              [pTooltip]="!isSidebarExpanded() ? subItem.label : undefined"
            >
              <app-user-avatar [users]="getusersFromMembers(subItem.spaceObj?.members)" />
              <span *ngIf="isSidebarExpanded()" class="ml-3 text-sm font-medium whitespace-nowrap"> {{ subItem.label }} </span>
            </a>
            }
          </div>
          }
        </div>
        } @else {
        <a
          [routerLink]="item.route"
          class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors text-neutral-700"
          [ngClass]="{ 'bg-[#3d3935]/10 border-l-4 border-[#3d3935]': isActive(item.route), 'hover:bg-gray-100': !isActive(item.route) }"
          [pTooltip]="!isSidebarExpanded() ? item.label : undefined"
        >
          <em [class]="item.icon" [ngClass]="{ 'text-gray-500': !isActive(item.route) }"></em>
          <span *ngIf="isSidebarExpanded()" class="ml-3 text-sm font-medium whitespace-nowrap"> {{ item.label }} </span>
        </a>
        } }
      </div>

      <div class="mt-auto overflow-x-hidden">
        <div class="flex w-full justify-center" [ngClass]="{ '!justify-end': isSidebarExpanded() }">
          <p-button
            icon="pi pi-angle-double-right"
            class="transition-transform duration-1000 ease-in-out flex"
            [ngClass]="{ 'rotate-180': isSidebarExpanded() }"
            severity="secondary"
            rounded
            text
            (click)="layoutService.toggleSidebarExpansion()"
            tooltipPosition="right"
          ></p-button>
        </div>
        <hr class="my-2 mx-1 border-t border-0 border-surface" />
        <p-button class="mb-4" text severity="secondary" (onClick)="menu.toggle($event)">
          <div class="flex items-center justify-center gap-2">
            <app-user-avatar [users]="authService.currentUser()" [size]="'large'"></app-user-avatar>
            <span *ngIf="isSidebarExpanded()" class="text-gray-500 font-semibold"> {{ authService.currentUser()?.fullname!.split(' ')[0] }} </span>
          </div>
        </p-button>
        <p-button
          [label]="isSidebarExpanded() ? 'Sair' : undefined"
          [icon]="'pi pi-sign-out'"
          severity="secondary"
          [styleClass]="(isSidebarExpanded() ? 'w-full justify-start !text-sm ' : 'mx-2')"
          (click)="authService.logout()"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-drawer>

<p-menu #menu [popup]="true" styleClass="px-2" appendTo="body">
  <ng-template #start>
    <div class="flex flex-col text-left text-gray-500 w-full py-1">
      <span class="font-semibold">{{authService.currentUser()?.fullname}}</span>
      <span class="text-xs">{{authService.currentUser()?.email}}</span>
    </div>
  </ng-template>
  <ng-template #end>
    <div class="border-t border-gray-300 w-full py-1">
      <p-button
        label="Configurações"
        icon="pi pi-cog"
        styleClass="w-full !justify-start !text-sm"
        text
        severity="secondary"
        aria-label="Sair do Gubi"
        (click)="navigateTo('/settings')"
      />
    </div>
    <div class="border-t border-gray-300 w-full py-1">
      <p-button label="Sair" icon="pi pi-sign-out" styleClass="w-full !justify-start !text-sm" text severity="secondary" aria-label="Sair do Gubi" (click)="authService.logout()" />
    </div>
  </ng-template>
</p-menu>
