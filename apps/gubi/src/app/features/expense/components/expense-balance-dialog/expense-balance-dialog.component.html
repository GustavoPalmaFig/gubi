<p-dialog
  header="Resumo das despesas"
  [modal]="true"
  [visible]="isOpen()"
  [closeOnEscape]="true"
  [dismissableMask]="true"
  (onHide)="close()"
  (visibleChange)="close()"
  styleClass="w-[95%] md:w-fit mx-4 w-lg dialog-with-subtitle"
>
  <p class="text-sm text-muted-foreground">Abaixo segue o balanço detalhado das despesas para o período selecionado.</p>

  <div class="my-6 flex justify-center w-full">
    <p-table
      [value]="expensesReport"
      stripedRows
      [paginator]="expensesReport.length > 8"
      [rows]="8"
      [rowsPerPageOptions]="[5, 8, 10, 20]"
      showCurrentPageReport
      currentPageReportTemplate="{last} de {totalRecords} registros"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Compra</th>
          <th>Valor</th>
          <th>Método</th>
          <th>Divisão</th>
          <th>Resultado</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-reportItem>
        <tr class="whitespace-break-spaces">
          <td>{{ reportItem.expense.title }}</td>
          <td>{{ reportItem.expense.value | currency: 'BRL' }}</td>
          <td>{{ reportItem.expense.payment_method.name}}</td>
          <td>
            @for(split of reportItem.splitDetails; track split) {
            <div class="flex justify-between w-full gap-2">
              <span class="w-1/3">{{ abbreviatedName(split.from.fullname, 1) }}</span>
              <span class="w-1/3 text-center">{{ split.value | currency: 'BRL' }}</span>
              <span class="w-1/3 text-right">({{ split.percentage }}%)</span>
            </div>
            }
          </td>
          <td>
            @for(debt of reportItem.debt; track debt) {
            <div class="flex justify-between w-full gap-1">
              <span>{{ abbreviatedName(debt.from.fullname, 1) }}</span>
              <span>→</span>
              <span>{{ abbreviatedName(debt.to?.fullname, 1) }}:</span>
              <span>{{ debt.value | currency: 'BRL' }}</span>
            </div>
            }
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="footer">
        <tr class="whitespace-break-spaces font-semibold bg-gray-100 border-none">
          <td>Saldo Final</td>
          <td>{{ accumulatedValue() | currency: 'BRL' }}</td>
          <td>-</td>
          <td>
            @for(accSplit of accumulatedSplitedValue; track accSplit) {
            <div class="flex gap-2">
              <span>{{ abbreviatedName(accSplit.from.fullname, 1) }}</span>
              <span>{{ accSplit.value | currency: 'BRL' }}</span>
            </div>
            }
          </td>
          <td class="flex flex-col gap-2">
            <div class="border-b border-gray-300 pb-2 mb-2">
              @for(accDebt of accumulatedDebt; track accDebt) {
              <div class="flex gap-1">
                <span>{{ abbreviatedName(accDebt.from.fullname, 1) }}</span>
                <span>→</span>
                <span>{{ abbreviatedName(accDebt.to?.fullname, 1) }}:</span>
                <span>{{ accDebt.value | currency: 'BRL' }}</span>
              </div>
              }
            </div>
            <div>
              @for(fDebt of finalDebt; track fDebt) {
              <div class="flex justify-between">
                <span>{{ abbreviatedName(fDebt.from.fullname, 1) }}</span>
                <span>→</span>
                <span>{{ abbreviatedName(fDebt.to?.fullname, 1) }}:</span>
                <span>{{ fDebt.value | currency: 'BRL' }}</span>
              </div>
              }
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-dialog>
